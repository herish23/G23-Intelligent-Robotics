"""
Batch Experiment Runner

This script finds all 'noise_*.yaml' config files in a specified directory,
then runs the full Markov localization algorithm for each one.
"""

import os
import glob
import time
from run_localization_gpu import run_single_experiment

# --- CONFIGURATION ---
# Point this to the folder containing all your 'noise_*.yaml' files
CONFIG_DIR = r'C:\Users\Rohit\Desktop\Intelligent Robotics\G23-Intelligent-Robotics\algorithms\markov\configs'
# --- END CONFIGURATION ---

def main():
    print("Starting batch localization experiment...")
    
    # 1. Find all noise config files
    # This searches for any file starting with 'noise_' and ending with '.yaml'
    config_pattern = os.path.join(CONFIG_DIR, 'noise_*.yaml')
    config_files = glob.glob(config_pattern)
    config_files.sort() # Sort them (e.g., noise_10, noise_20, ...)
    
    if not config_files:
        print(f"Error: No config files found matching '{config_pattern}'")
        print("Please check the 'CONFIG_DIR' path.")
        return

    print(f"Found {len(config_files)} experiments to run:")
    for f in config_files:
        print(f"  - {os.path.basename(f)}")

    # 2. Run each experiment
    start_time_all = time.time()
    results = []

    for config_path in config_files:
        exp_name = os.path.basename(config_path).replace('.yaml', '')
        print(f"\n{'='*70}")
        print(f"RUNNING EXPERIMENT: {exp_name}")
        print(f"{'='*70}")
        
        start_time_exp = time.time()
        
        # This calls your modified localization script
        avg_error = run_single_experiment(config_path) 
        
        if avg_error is not None:
            print(f"EXPERIMENT '{exp_name}' COMPLETE. (Took {time.time() - start_time_exp:.2f}s)")
            print(f"Average Position Error: {avg_error:.3f} m")
            results.append((exp_name, avg_error))
        else:
            print(f"EXPERIMENT '{exp_name}' FAILED.")
            results.append((exp_name, "FAILED"))

    # 3. Print final summary
    print(f"\n\n{'='*70}")
    print("BATCH RUN COMPLETE")
    print(f"Total time: {time.time() - start_time_all:.2f}s")
    print("\n--- Final Summary ---")
    for exp_name, avg_error in results:
        # Print the error result, formatted
        if isinstance(avg_error, float):
            print(f"  {exp_name:<15}: {avg_error:.3f} m")
        else:
            print(f"  {exp_name:<15}: {avg_error}")
    print("="*70)

if __name__ == "__main__":
    main()